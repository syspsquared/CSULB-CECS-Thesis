\chapter{Lab Installation} \label{ch:lab_install}
\section{Lab Images} \label{sec:lab_images}
\subsection{Overview}
The most time consuming part of managing a lab is building and maintaining the master image to the lab.  All workstations in the lab are clones of either the Windows master image or the Linux master image.  Linux master images are rebuilt every semester while Windows master images are upgraded.  Details on cloning can be found in Chapter~\ref{ch:lab_installation}, Section~\ref{sec:cloning}.  Descriptions on the various steps to build the master image are here.  What is most important about the image is the instruction set used to build it.  The actual image itself is pointless if there are no instructions on how it was built.  If instructions exist, they can further be tailored if distribution upgrades are made, or possibly if the choice of distribution changes.  

We determine what goes into the image by taking input from faculty and students from past semesters as well as from our own experience.  Our cycle involves building during the summer or winter months with changes noted from the previous semester.  We test as much as we can once the image is built.  Once we can consider the image relatively stable, we begin the cloning process.  We cannot test for all cases, so unfortunately, most of the testing occurs by the students and faculty during the next semester.  Changes during the semester are very difficult because we have to close down all the labs.  We can do minor changes with ssh pushes.  In extreme cases where functionality is broken to the point where a course can not be taught, we will rebuild the master image, close the labs on a Friday because it has fewest classes, and clone again with the changes.  This is always a last resort because it involves downtime and lab courses canceled for the day.  In addition, a change to fix something always has the risk of potentially breaking something else.  

This would be less of an issue if we got more early feedback from faculty members, but we have not found a solution to that problem.  As a workaround, we will occasionally poll the students taking the courses.  This might not work as some students polled may request something that is either infeasible or was just not made known to them by their instructor.  For example, students periodically ask if we can synchronize their files across Windows workstations without having to use a shared drive.  This is infeasible because it puts heavy strain on our lab switches.  It might be possible if we upgraded them, but this would require far more funding than we are reasonably allocated.  Some students, particularly seniors or graduate students, have been around our labs long enough to offer helpful feedback.  Generally, student requests are considered and will be used subject to feasibility and security concerns. 

Exactly what goes into the image is difficult to determine because of the changes.  Some things rarely change while others are temporary fixes that change every semester.  In the appendix section, I have provided a copy of our current install\_master instructions in \ref{appendix install}.  They are only valid now and will be changed at our next release cycle.  All of the following instructions will have a corresponding entry in the instructions. 

\subsection{Booting from Install Media}
At some point, a CD or DVD must be used to run the installer for the image.  This may not be a physical disk if the image is netbooted, but for CECS labs, we have not found a way to netboot from our chosen distribution of Ubuntu.  Fortunately, the CD only needs to be used once on the master image.  The rest of the labs can be cloned via network.  Once the CD starts, some type of setup program or script must be run to do a standard install of the distribution.  How this setup is run varies depending on the distribution.  In CECS, we run the server edition of Ubuntu and do a basic install with nothing but essentials running.  We added the various packages we need later.  

\subsection{Setting Up Administrative User}
Sometimes during the install, it will prompt to create a non-root administrator account.  This is because Unix and Linux should usually not be run directly with the root user under normal circumstances.  In our lab environment, the root user is only used to do ssh pushes and troubleshoot issues.  However, some distributions will force creation of a non-root system administration account.  To workaround this, we create an account called dummy.  After the install is finished, we use the administrative privileges this account grants to set a root passwd, then we use root to delete the account.  

\subsection{Setting Up Networking}
Network settings vary depending on how dhcp is set up.  The most important aspect of network settings is making sure a workstations hostname matches its physical label.  This is the only way to ensure each machine can be identified for troubleshooting purposes.  As mentioned in the printserver section, the dhcpd server can be given a list of MAC address mappings to IP addresses so that all the client machines can be set to take their network settings from dhcp.  The alternative is using static IP addresses which will require going to each machine during the cloning process and assigning the IP which matches the physical label.  How the settings are set depends on the distribution.  They are usually found in the ``/etc" directory somewhere.  

\subsection{Master Package List and Installation}
The reason we only install essentials during the CD install stage is because we only install packages we need.  We build a master packages list of things to install and run that list into a package manager.  The manager then goes out to its distribution's download site and fetches the packages requested.  It then handles the installation process and dependency resolving for all packages it is able to retrieve.  This process requires minimal interaction from a system administrator.  As a result, the number packages that can be installed is only limited by the minimum size of the disks the image will be cloned onto.  Since most Linux distributions rarely take up more than 10-15 gigabytes and we have disks of at least 80 gigabytes large.  

After the installation of packages, we remove unneeded packages that were brought in during the install process.  In CECS labs, the most important package to remove is CUPS since we use LPRNG for printing and the two can conflict. Ubuntu provides a nice ``autoremove" command that removes unneeded packages. We run this at the very end of the installation. 

\subsection{Manual Package Installation}
The package list only works for packages that are available from the Linux distribution's package repositories.  If a faculty member requests a package that is not available in the standard repository, it must be added manually to the image.  This will require extra work on the part of the system administrator building the image, so there should be a limit placed on the number of manual packages to install.  This can be lessened if an automated script can be used.  Actual instructions for installing packages manually varies depending on the package.  Sometimes, files only need to be copied to an executable path to be run.  Other times, they must be compiled from source code.  And for some complicated packages, there may be an arbitrary number of steps to set up and install the package.  

\subsection{Text-Only Login}
Part of our environment involves keeping text-only login screens and command lines.  This allows us to run courses which students will primarily use the command line for.  This will build their experience with it which is important for many industry jobs.  It also allows us to use special shell accounts that will run scripts on login.  For example, we use a user account called ``search" with the password ``account" that runs an account creation script at login that students use to register new accounts.  

Actually enabling text-only mode seems to be becoming harder and harder with each new Linux distribution release.  Most want to boot straight into a graphical user interface (GUI) to handle logins.  This makes sense for non-technical users, but makes things difficult for technical students.  Until recently, the easiest way was to set the default runlevel to 3.  This will allow networking and multiple users while remaining in text mode.  However, this is only possible on systems that run the classic Unix init process.  Our current distribution, Ubuntu, does not use init.  We have managed to still get text mode by removing the configuration script for the GUI login interface.  This presents several other problems, but after carefully working through them, we have managed to get our current system stable.  With each new distribution release though, new workarounds are needed for problems that appear.  

\subsection{Automount}
Information on what automount does can be found in Chapter~\ref{ch:lab_maintenance}, Section~\ref{sec:filesystem_management}.  We have automated its setup by just copying the configuration files to the appropriate directory.  However, upgrading in the past has invalidated our configuration file.  With each new image, we confirm that the configuration still works and find out how to fix it if it does not. 

\subsection{Groups}
Some of the groups in the ``/etc/groups" configuration file must be renamed or added.  We have a faculty group, a student group, and a staff group.  They have numbers 30, 40, and 50 respectively.  Back when they were created, there were not many Unix system groups, so the original administrators were not worried about conflicts.  While there are conflicts today, renaming the groups has not caused any known issues except on the Apple Macintosh platform.  

\subsection{Limiting Student Control}
There are certain tools that we wish to prevent students from using.  Any tool related to disabling the machine in some way has to be prevented.  All methods of putting the machine on standby or hibernation have to be removed from student control.  This is difficult to do because they usually have the ability to do this from the GUI interface.  Disabling controls in this interface is not always well documented.  In addition, students should be prevented from doing a total shutdown and even rebooting the machines.  This is because while the machines are powered off, they cannot be accessed remotely and must be physically powered on again.  In addition, the combination ctrl-alt-del has historically been used to reboot the machines, so this must also be disabled.  

Students must also be prevented from editing their own account information, particularly the name information because this is how we identify them.  Since our environment uses Unix NIS and YP  maps, some YP tools must be disabled from student access.  We do this by replacing the ``ypchfn", ``ypchsh", and ``yppasswd" binaries with dummy versions that only print warnings.  Local versions of these tools are similarly replaced.  We do this because in order to maintain our crossplatform accounts, we must force students to only create and change account information and passwords through the custom interface we have created.  Further information on this can be found in the crossplatform considerations section.

\subsection{Power Saving Configuration}
To conserve power, we set the monitor to go black after 15 minutes, and turn off after 30 minutes.  This is set in the ``/etc/rc.local" configuration file which runs at startup.  

\subsection{System Log Configuration}
Our system logs are usually retained for only 30 days.  However, we set them to stay for a semester long (15 weeks) to match our semester environment.  This way, we can see a trail of logs if a problem has been occurring all semester long.  We can also optionally set up log forwarding to a central log server for auditing purposes.  However, we have not been required to do this.  Furthermore, a log server would need to have many gigabytes of storage space to hold logs for all of our workstations for a semester.  

\subsection{Secure Shell Key Setup}
Descriptions for setting up and configuring ssh can be found in Section~\ref{sec:ssh_push}.  We have further automated this by creating a tarball of a properly configured ssh directory and then untarring the files onto the new master image.  

\subsection{Lab Printing}
A description of our printing system can be found in Section~\ref{sec:lab_printing}.  A default printer must be chosen for the master to test printing, but it will be overridden during the cloning process.  In addition, the ``paper" command must be copied down so that users can check their quotas.  

\subsection{Local Support Commands}
Our support commands are described in Section~\ref{sec:student_faculty_help}.  All we do on the master image is copy them to the appropriate place, set their permissions, and test them to make sure upgrades have not broken them.  We attempt to fix them if they are broken. 

\subsection{Restricting Access}
Access to the machines should be restricted only to those who need to use them.  We restrict access to our labs by only allowing students who are Computer Engineering or Computer Science majors or who are taking a CECS course.  We do this by carefully managing the authorized user accounts on our nameserver.  When students no longer have a need to access the workstations, their shell is set to an expired shell that prints an error message before logging them out.  They can still use the ftp protocol to reach their files though.  After a semester, we remove their accounts and all associated files.  

Steps have to be taken to restrict outside access to workstations as well.  In our environment, every workstation has a public facing IP address.  Access to it should therefore be restricted.  We do this by only allowing connections from IP addresses in our environment and denying everything else.  This is done through the ``/etc/hosts.allow" and ``/etc/hosts.deny" configuration files.  While this works fine for us, it is not ideal because every server and workstation must be configured this way.  For clones, it is not much of an issue, but for servers these steps could potentially be forgotten.  That would expose the server to attackers from across the Internet.  Ideally, our environment should be behind a restricted firewall module that would have a strict access control list (ACL).  This module is exceedingly expensive however.  We have a layer 3 switch that can do simple ACLs, but we must still secure each workstation ourselves and through the cloning process.  An even more secure route would be to use a Virtual Private Network (VPN) module that only allows authenticated users to connect to our network.  This has been implemented campus wide, but we cannot justify the added cost of VPN modules to implement it for our network.

\subsection{NTP Server}
The network time protocol (NTP) server must be pointed to the same server that every other machine in the lab does.  This is necessary because all machines should have the same time for troubleshooting purposes.  

\subsection{Bootloader Setup}
The bootloader settings must define what hard drive partition to point to, what kernel to link to, what label the system is called, and what type of video output should be used.  These are defined in the ``/etc/lilo.conf" file.  These are necessary for the clones because they will be reading this configuration file to create a boot sector.

\subsection{Rebooting to Cleanup}
Descriptions of unclogging methods can be found in Section~\ref{sec:unclogging}.  It is currently implemented by adding the reboot command to root's crontab at 3 AM every night.  

\subsection{Login Scripts}
Login scripts are run every time a user logs in.  That can be made as quick fixes to issues that users may be having.  Currently, we only have two.  All of the other fixes were temporary and permanent workarounds were found.  One script sets the environment variable ``hostname" to be the system hostname for backward compatibility reasons.  The other script checks a users diskspace and displays a screen warning if it is too low.  

\subsection{Message of the Day}
The default message of the day (MOTD) gives a lot of useless information for students.  Instead, we change it so that it only shows a welcome message and explains how to use the GUI interface.  

\subsection{Miscellaneous Tweaks}
There are other miscellaneous tweaks we make to the image.  These tweaks are mostly on a per release basis and change each semester.  What may have been a problem with one distribution release may be fixed in another.  

It would be impossible to document all of these tweaks so I will provide some common examples.  For instance, the Mozilla Firefox web browser makes all sorts of changes between releases that could bring up problems.  With the latest release, the local cache has been raised to 1GB.  Our quotas are only capped at 512MB, so Firefox alone could fill up a student's quota.  Some simple examples involve a program name changing.  The email client pine changed to alpine.  This confused users who were used to running pine, so we created a symbolic link from the pine command to the alpine command.  The ctrl-alt-backspace key combination was the default method to shut down the GUI interface.  It changed in one release to the confusion of users, so we had to manually rebind it to the way it was.  Lastly, there are all sorts of issues with each window manager release.  In our latest lab image, the newest window manager was broken, so we had to force the old one to be used.  

\subsection{Considerations for Different Hardware Architectures} 
We have had issues with going from a 32 bit architecture to 64 bit.  The first issue involved the fonts for the system changing to a different package.  Adding that package to the master package list fixed it.  We also to recompiled our custom programs to 64 bit because in the latest release of Ubuntu, libraries that support 32 bit code were not installed by default.  We also added the 32 bit libraries to our package list in case we still need the compatibility.  We have also run into cases where the default 64 bit drivers would not support our hardware, so we have had to recompile the drivers and add them as kernel modules.  

\subsection{Summary}
Overall, each semester, the master image requires considerable effort to ensure it is adequate for use in our labs.  However, once it is built, our cloning process allows us to clone all ninety of our Linux workstations in just over two hours.  This assumes no problems occur along the way and we always have a few each time. 
